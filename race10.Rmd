```{r echo = FALSE}
opts_chunk$set(echo = FALSE)
```
#  One of the greatest sailboat races of all time meets statistical graphics

``` {r}
library(ggplot2)
library(plyr)
```

I don't know if you've been following the [America's Cup](http://americascup.com). It's the oldest sailing competition and, by some accounts, the oldest sporting event bar none. This year, this time honored event has been thrust into the modern age with the adoption of foiling winged catamarans that skim the water of San Francisco Bay at 90 Km/h. Not only that, the competition has also entered the Big Data age with 30,000 data points per second generated by onboard sensors, not to mention the multiple video feeds, the enhanced reality visuals and more.

The prospect of having some of that data made available was mouth watering. It turns out that for one race what is shared is a paltry 14,000 records and all the columns corresponding to on board instruments contain only zeros and America's cup data engineers have confirmed the omission is necessitated by the rules. Well, we'll have to have some fun with what's there.

``` {r}
r10 = 
	rbind(
		read.csv("~/Downloads/130915/csv/20130915133810-NAV-NZL.csv"), 
		read.csv("~/Downloads/130915/csv/20130915133810-NAV-USA.csv"))
```

``` {r}
r10 = subset(r10, Secs > 51960 &  Secs < 51960 + 1336)
```

``` {r}
diff0 = function(x) c(0, diff(x))
r10 = ddply(r10, "Boat", function(x) {x$LonUnfolded = cumsum(abs(diff0(x$Lon)));x})
r10$multiple.wind.speed = with(r10, SOG/CourseWindSpeed)
r10$point.of.sail = with(r10, (Hdg - CourseWindDirection)%%360)
r10$RVMG = with(r10, cos(pi * point.of.sail/180) * multiple.wind.speed)
r10$min = with(r10, (Secs - min(Secs))/60)
```

``` {r}
r10ss = subset(r10, round(Secs * 10) %%1000 == 500 )
```

I wanted to build some high density graphics that showed the crucial events of the race. Some of answers offered by the graphics would need to be confirmed more rigorously with a confidence interval but we will stop short of that in this article. The first is going to be based on the position of the boats and this is what happens just plotting longitude and latitude of the boats, captured 5 times per second:

```{r fig.width = 5, fig.height=5}
ggplot(
	r10, 
	aes(
		Lon, 
		Lat, 
		col = Boat)) +
	geom_point()

```

Since the race goes back and forth three times in between two gates, the overlap of the yachts' trajectories makes this first visualization hard to read, so I decided to mirror the Longitude every time the sailboats reach a mark (sailing speak for turn around point). Imagine the race course as a folded piace of paper and the visualization as its unfolded version, with the creases in the north-south direction at the marks. Speed is important, so I decided to use color to represent speed. Since in sailing "fast" is only relative to the wind, I learned to use the ratio of boat speed to wind speed from America's Cup commentators, accomplished sailors Gary Jobson and Ken Read. On the day of Race 10 this ranged between 0.5 on some not-so-good tacks (upwind turns), when the boat is briefly traveling against the wind, to 2.7. Symbols are used to represent the teams. A nice side effect of this is that the symbols show the position of the boats at regular time intervals, suggesting which one is ahead particularly near a cross. In sailing, speed is not everything: equally important is angle w.r.t the wind, since sailboats can't go straight upwind and can go straight downwind only paying a crippling speed penalty, and the course is roughly aligned with the wind. Eventually what matters is a combination of speed and angle which is called *velocity made good*, or VMG. As for raw speed, what a good VMG is depends on the intensity of the wind, so it makes sense to take the ratio of VMG and wind speed, which I call *relative VMG* or RVMG. In the following graphics, this is expressed as thickness of the line. It is somewhat redundant as we have direction and speed information already, but it's a convenience. To summarize, the following graphics shows the trajectory of the two boats with the twist that the race course is replicated three times and mirrored as needed to avoid overlaps; color is speed and thickness is RVMG. The symbols identify the boats and their position at regular time intervals. 

``` {r fig.width = 21, fig.height = 7, tidy = FALSE}
ggplot(
	r10, 
	aes(
		LonUnfolded, 
		Lat, 
		col = multiple.wind.speed,
		size = abs(RVMG),
		shape = Boat)) +
	scale_color_gradient(low = "green", high = "red") +
	geom_point(shape = 1) + 
 	geom_point(
 		data = r10ss, 
 		color = "white", 
 		size = 4) 
```

If you watched this fantastic race, hailed  as one of the greatest sailing contests ever, you can see all of its decisive moments in this graphic. The race started with a very fast reach, with team New Zealand (NZL) pushing team USA (USA) wide at the first mark rounding. USA has a difficult *jybe* (turn going downwind) as their line turn green, unlike NZL's. The two boats go in sync down to mark 2, with USA following a closer angle for one tack &mdash; maybe a wind shift, that's where having on board data would help. At the Mark USA goes for a complicated manouver to obtain a split &mdash; a split is always preferred by the chaser, as these boats always leave disturbed air behind them, irrespective of wind; such is their speed &mdash; but the manouver costs them dearly in boat speed. In the upwind leg, the boats seem happy to criss-cross paths as the leader doesn't make a defensive tack over their opponent, probably mindful that a similar move cost them almost a capsize in a previous race. The problem is that tacks require a lot of work and the crews can only produce so many tacks before getting exhausted. Peaks in speed at the crossings show the boat on port tack taking evasive manouver to avoid collision, while the one on starboard tack, with the right of way, tries to make it hard on the other boat, but there were no clear *dial downs* as in other races, when the right of way boat takes aim at the other. Right before mark 3, the two boats part ways: USA ducks deeply behind NZL whereas NZL slows down heading upwind and goes into the mark rounding with a zig-zag. USA speed seems to suffer after the last jybe and they go into the dowind leg with a slight deficit, but with the split. At the first cross, a decision looms between ducking (and losing ground) or jybing (losing the split). As USA tactician Ainslie later exlained, neither looks good, and they duck. NZL is clear at their next crossing and, without major errors, the race is over. USA fails to keep the pressure up though with a poor last mark rounding. 

Now I would like to transition into a different, more abstract visualization, but before doing that I need to show a version of the previous graphics with color representing time.

``` {r fig.width = 9, fig.height = 3}
rainbow = scale_color_gradientn(colours = c("red", "orange", "yellow", "green", "blue", "violet"))
ggplot(
	r10, 
	aes(
		LonUnfolded, 
		Lat, 
		col = min)) +
	rainbow +
	geom_point() 
```

This isn't so interesting *per se* but you need to keep an eye on it to read the next graphics, where time is represented by the same color scale. The next graphics is focused on speed and direction w.r.t the wind, what sailors call *point of sail*. In polar coordinates, imagine the wind coming from above and the boat with its *stern* (rear end) in the center and its *bow* (front) pointing out. The labels are the traditional names for different points of sail: *in irons* (against the wind), *closed haul* (almost against the wind) and so forth. The distance from the center is boat speed relative to the wind. Color represents time and going back and forth to and from the previous graphic you can associate the different colors with various phases of the race. Each point represents a speed and direction reading, repeated five times a second and each boat has a separate panel. As you can see, the points are not randomly scattered. Boats tend to stay on a course that gives them the best VMG most of the time. The biggest exceptions are the blue and purple clusters, which are the beginning and final stretches of the race, which are oriented at almost 90 degrees to the wind and as such VMG doesn't matter here, only speed. So the main six clusters are port and starboard tack, port and startboard jybe and the two final reaches. In between these we see connecting lines: roughly horizontal we have tacks (upper half) and jybes (lower half); vertically we have mark roundings. There's a few lines of dots that don't fit any of the above: the acceleration from the start in red and a few "tactical" situation such as NZL zig-zagging before mark 3 (in blue-green) and USA ducking deep (green), how scattered the final run is for USA compared to the tight cluster of points for NZL (in purple) and how more consistent are jybe speeds for NZL. In favor of USA, we can see slightly faster speeds through the tacks.

```{r}
points.of.sail = c("In Irons", "Close Hauled", "Close Reach", "Beam Reach", "Broad Reach", "Running", "Running", "Running", "Broad Reach", "Beam Reach", "Close Reach", "Close Hauled")
p.o.s = abbreviate(points.of.sail)
scale.x = 
	scale_x_continuous(
		name = "Point of Sail", 
		limits = c(0, 360), 
		breaks = seq(0, 360-1, by = 30), 
		labels = points.of.sail)

scale.y = scale_y_continuous(name = "Multiple of Wind Speed", limits = c(0, 3)) 
```


``` {r fig.width = 21, fig.height = 11, tidy = FALSE}
ggplot(
	r10, 
	aes(
		point.of.sail, 
		multiple.wind.speed, 
		color = min)) +
	scale.x + scale.y + coord_polar() +
	rainbow +
	geom_jitter(alpha = .2) + 
	facet_grid(.~Boat)
```
By promoting speed from a color scale to a more perceptually precise spatial scale, we can gain new insights, like the remarkable speed difference between the two teams rounding mark 2 (in yellow) , how scattered is the final run for USA compared to the tight cluster of points for NZL (in purple) and how more consistent are jybe speeds for NZL. In favor of USA, we can see slightly faster speeds through the tacks.

``` {r fig.width = 21, fig.height = 11, tidy = FALSE}
# ggplot(
# 	r10, 
# 	aes(
# 		point.of.sail, 
# 		abs(RVMG), 
# 		color = min)) +
# 	scale.x + coord_polar() +
# 	rainbow +
# 	geom_jitter(alpha = .2) + 
#	facet_grid(.~Boat)
```

``` {r fig.width = 21, fig.height = 11, tidy = FALSE}
#ggplot(
# 	r10, 
# 	aes(
# 		point.of.sail, 
# 		ifelse(
# 			pmin(abs(point.of.sail - 90),abs(point.of.sail - 270)) < 30,
# 			.5 * multiple.wind.speed, 
# 			abs(RVMG)),
# 		color = min)) +
# 	scale.x + coord_polar() +
# 	rainbow +
# 	geom_jitter(alpha = .2) + 
#	facet_grid(.~Boat)
```

The problem with this visualization is in the tight clusters of points, that is the straight line mode. It'hard to detect the density of points, that is the time a boat has spent traveling at a certain speed. So let's now drop the indidual data points. In the next graph, the density of color red is proportional to the time spent sailing at a certain point of sail and speed. 


``` {r fig.width = 21, fig.height = 11,  tidy = FALSE}
ggplot(
	r10, 
	aes(
		point.of.sail, 
		multiple.wind.speed)) +
	scale.x + coord_polar() +
	stat_bin2d()+ 
	scale_fill_gradient(low = "light grey", high = "red") +
	facet_grid(.~Boat)
```

We can see that, upwind, USA seems to travel a bit more close hauled whereas NZ is a little faster. Impossible to tell by eye who has the best compromise. On the donwind side, particularly on starboard, NZL seems to travel as if on tracks, with a very tight cluster of points, probably due to longer starboard tacks. Now for a final set of graphics, we focus on speed and point of sail separately. But since speed without direction does not a race win, let's switch to RVMG. And to avoid mixing apples and oranges, let's try to analyze straight line speed vs speed in the turns. I made up a "turn test" based on boat heading 10 second moving averages. The next graphics confirms that the test and  intuition mostly agree on what a turn is.

```{r}
r10 = transform(r10, turn = abs(diff0(filter(Hdg, rep(.02, 50)))) > 0.2)
ggplot(r10, aes(LonUnfolded, Lat, color = turn)) + geom_point()
```

With that available, we can now look at the frequency of different points of sail. A density plot in polar coordinates may look unfamiliar, but the meaning is pretty simple: the furthest a line is from the center, the longer a boat has spent traveling at that point of sail.

``` {r}
r10sl = subset(r10,  !turn)
ggplot(r10sl, aes(point.of.sail, color = Boat)) + 
	scale.x + coord_polar() +
	geom_density(adjust = 0.2)
```

What we see is that indeed USA sails a bit more close hauled both upwind and downwind. But does it pay off  in terms of RVMG? In the next plot, negative RVMG is just RVMG downwind.

```{r}
ggplot(r10sl, aes(RVMG, color = Boat)) + geom_density()
```

It seems that it does upwind, but not downwind. And what about the turns?


```{r}
r10tr = subset(r10, turn)
ggplot(r10tr, aes(RVMG, color = Boat)) + geom_density()
```

Well, it looks like the tacks are pretty even, contrary to the impression create by a previous graphics. Maybe just the worse NZL tack was worse, but overall they seem even with their opponent. 

## Materials and Methods

